# üöÄ Sistema de Monitoreo de Railway - Gu√≠a Completa

**ClickUp Project Manager - Railway Monitoring System**

---

## üìã √çndice

1. [Descripci√≥n General](#descripci√≥n-general)
2. [Caracter√≠sticas Principales](#caracter√≠sticas-principales)
3. [Instalaci√≥n y Configuraci√≥n](#instalaci√≥n-y-configuraci√≥n)
4. [Uso del Sistema](#uso-del-sistema)
5. [Dashboard Web](#dashboard-web)
6. [API de Monitoreo](#api-de-monitoreo)
7. [Sistema de Alertas](#sistema-de-alertas)
8. [Ejemplos de Uso](#ejemplos-de-uso)
9. [Soluci√≥n de Problemas](#soluci√≥n-de-problemas)
10. [Mantenimiento](#mantenimiento)

---

## üéØ Descripci√≥n General

El **Sistema de Monitoreo de Railway** es una soluci√≥n integral para supervisar la salud, performance y estabilidad de tu aplicaci√≥n desplegada en Railway. Proporciona monitoreo en tiempo real, alertas autom√°ticas y un dashboard web interactivo.

### ¬øQu√© monitorea?

- ‚úÖ **Tiempo de respuesta** del sistema
- ‚úÖ **Tasa de errores** por hora  
- ‚úÖ **Uso de CPU y memoria**
- ‚úÖ **Estado de la base de datos**
- ‚úÖ **Conectividad general**
- ‚úÖ **Logs del sistema**
- ‚úÖ **M√©tricas de performance**

### ¬øC√≥mo te avisa?

- üìß **Email** (SMTP configurado)
- üì± **WhatsApp** (Evolution API)
- üìä **Dashboard web** en tiempo real
- üìù **Logs estructurados**
- üîî **Integraci√≥n con LangGraph**

---

## ‚≠ê Caracter√≠sticas Principales

### üîç Monitoreo Inteligente
- **Health checks** autom√°ticos cada 30 segundos
- **Detecci√≥n de patrones** de errores
- **An√°lisis de tendencias** de performance
- **Alertas predictivas** basadas en thresholds

### üö® Sistema de Alertas Avanzado
- **4 niveles de alerta**: INFO, WARNING, ERROR, CRITICAL
- **6 tipos de problemas**: Sistema ca√≠do, errores altos, respuesta lenta, DB error, CPU/memoria altos
- **Cooldown autom√°tico** para evitar spam de notificaciones
- **Resoluci√≥n autom√°tica** de alertas cuando se soluciona el problema

### üìä Dashboard Interactivo
- **M√©tricas en tiempo real** con gr√°ficos
- **Estado visual** del sistema
- **Logs recientes** con filtros
- **Controles del sistema** desde la web
- **Responsive design** para m√≥viles

### üîß API REST Completa
- **15+ endpoints** para gesti√≥n del monitoreo
- **Exportaci√≥n de datos** en JSON/CSV
- **Control remoto** del sistema
- **M√©tricas hist√≥ricas** personalizables

---

## üõ†Ô∏è Instalaci√≥n y Configuraci√≥n

### Prerequisitos

```bash
# Verificar Python 3.8+
python --version

# Instalar dependencias
pip install -r requirements.txt
```

### Dependencias Principales

```txt
aiohttp>=3.8.0      # Cliente HTTP as√≠ncrono
psutil>=5.9.0       # M√©tricas del sistema  
fastapi>=0.68.0     # API REST
pydantic>=1.8.0     # Validaci√≥n de datos
chart.js            # Gr√°ficos del dashboard
```

### Variables de Entorno

Configura estas variables en Railway:

```env
# Sistema de monitoreo
RAILWAY_MONITORING_ENABLED=True
RAILWAY_MONITORING_INTERVAL=30
RAILWAY_ALERT_ERROR_THRESHOLD=5
RAILWAY_ALERT_RESPONSE_THRESHOLD=5.0

# Notificaciones por email
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=tu_email@gmail.com
SMTP_PASSWORD=tu_app_password
SMTP_FROM=tu_email@gmail.com

# Notificaciones por WhatsApp
WHATSAPP_ENABLED=True
WHATSAPP_NOTIFICATIONS_ENABLED=True
WHATSAPP_EVOLUTION_URL=tu_evolution_api_url

# Logging
LOG_LEVEL=INFO
LOG_FILE=logs/railway_monitor.log
```

### Configuraci√≥n en Railway

1. **Variables de entorno**: Configura las variables arriba en tu proyecto Railway
2. **Reiniciar servicio**: Railway aplicar√° autom√°ticamente los cambios
3. **Verificar**: Accede a `/railway-monitor` para ver el dashboard

---

## üöÄ Uso del Sistema

### 1. Inicio R√°pido

```bash
# Verificar que todo est√© configurado
python scripts/start_railway_monitoring.py --check-only

# Monitoreo por 1 hora
python scripts/start_railway_monitoring.py --duration 1

# Monitoreo continuo (Ctrl+C para detener)
python scripts/start_railway_monitoring.py
```

### 2. Opciones Avanzadas

```bash
# Intervalo de 15 segundos
python scripts/start_railway_monitoring.py --interval 15

# Sin alertas autom√°ticas
python scripts/start_railway_monitoring.py --no-alerts

# Thresholds personalizados
python scripts/start_railway_monitoring.py \
  --error-threshold 10 \
  --response-threshold 3.0

# Probar notificaciones
python scripts/start_railway_monitoring.py --test-notifications

# Ver informaci√≥n del sistema
python scripts/start_railway_monitoring.py --info
```

### 3. Acceso al Dashboard

Una vez iniciado tu aplicaci√≥n, puedes acceder al dashboard en:

```
https://tu-app.up.railway.app/railway-monitor
```

---

## üìä Dashboard Web

### Secciones Principales

#### üéõÔ∏è **Header del Sistema**
- Estado actual (üü¢ Operativo, üü° Degradado, üî¥ Error)
- Timestamp de √∫ltima actualizaci√≥n
- Enlaces r√°pidos a m√©tricas

#### üìà **M√©tricas Principales**
- **Tiempo de Respuesta**: ms promedio
- **Errores por Hora**: conteo de errores
- **Uso de CPU**: porcentaje actual
- **Uso de Memoria**: porcentaje actual

#### üìä **Gr√°ficos Interactivos**
- **Performance Chart**: L√≠neas de tiempo de m√©tricas (24h)
- **Alerts Chart**: Distribuci√≥n de tipos de alertas

#### üîî **Alertas Activas**
- Lista de problemas actuales
- Nivel de severidad con colores
- Timestamp y detalles t√©cnicos

#### üéÆ **Controles del Sistema**
- üîÑ **Actualizar Datos**: Refresh manual
- üì• **Exportar Logs**: Descarga en JSON
- üì± **Probar Alertas**: Test de notificaciones
- ‚ñ∂Ô∏è **Iniciar/Detener**: Control del monitoreo

#### üìù **Logs Recientes**
- √öltimas 100 entradas de logs
- Filtros por nivel (INFO, WARNING, ERROR)
- Formato legible con timestamps

### Caracter√≠sticas del Dashboard

- ‚úÖ **Actualizaci√≥n autom√°tica** cada 30 segundos
- ‚úÖ **Responsive design** para m√≥viles
- ‚úÖ **Tema moderno** con colores consistentes
- ‚úÖ **Gr√°ficos interactivos** con Chart.js
- ‚úÖ **Indicadores visuales** de estado
- ‚úÖ **Controles en tiempo real**

---

## üîå API de Monitoreo

### Endpoints Principales

#### Status del Sistema
```http
GET /api/v1/railway/status
```
Respuesta:
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "system_status": "healthy",
  "railway_url": "https://tu-app.up.railway.app",
  "monitoring_active": true,
  "active_alerts_count": 0,
  "environment": "production",
  "version": "1.0.0"
}
```

#### M√©tricas Actuales
```http
GET /api/v1/railway/metrics
```
Respuesta:
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "response_time": 234.5,
  "error_rate": 2,
  "cpu_usage": 45.2,
  "memory_usage": 67.8,
  "active_alerts": 1,
  "system_status": "healthy"
}
```

#### Historial de M√©tricas
```http
GET /api/v1/railway/metrics/history?hours=24
```

#### Alertas del Sistema
```http
GET /api/v1/railway/alerts?active_only=true
```

#### Logs Recientes
```http
GET /api/v1/railway/logs?limit=100&level=ERROR
```

### Control del Monitoreo

#### Iniciar Monitoreo
```http
POST /api/v1/railway/monitoring/start
Content-Type: application/json

{
  "interval": 30,
  "duration_hours": 2,
  "enable_alerts": true,
  "alert_threshold_errors": 5,
  "alert_threshold_response_time": 5.0
}
```

#### Detener Monitoreo
```http
POST /api/v1/railway/monitoring/stop
```

#### Estado del Monitoreo
```http
GET /api/v1/railway/monitoring/status
```

### Alertas Personalizadas

#### Crear Alerta
```http
POST /api/v1/railway/alerts
Content-Type: application/json

{
  "level": "warning",
  "title": "Problema Personalizado",
  "message": "Descripci√≥n del problema",
  "details": {
    "custom_field": "custom_value"
  }
}
```

### Utilidades

#### Probar Notificaciones
```http
POST /api/v1/railway/test/notifications
```

#### Exportar Logs
```http
GET /api/v1/railway/export/logs?date=2024-01-15&format=json
```

#### Health Check
```http
GET /api/v1/railway/health
```

---

## üö® Sistema de Alertas

### Niveles de Alerta

| Nivel | Color | Descripci√≥n | Notificaci√≥n |
|-------|--------|-------------|--------------|
| **INFO** | üîµ Azul | Informativo | No |
| **WARNING** | üü° Amarillo | Atenci√≥n requerida | Email |
| **ERROR** | üü† Naranja | Problema serio | Email + WhatsApp |
| **CRITICAL** | üî¥ Rojo | Sistema en riesgo | Email + WhatsApp + Log |

### Tipos de Alertas

#### üö® **CRITICAL - Sistema No Responde**
- **Trigger**: Endpoint principal no responde
- **Threshold**: 3 fallos consecutivos
- **Acci√≥n**: Notificaci√≥n inmediata

#### ‚ùå **ERROR - Tasa Alta de Errores**
- **Trigger**: >5 errores por hora (configurable)
- **Threshold**: Basado en `alert_threshold_errors`
- **Acci√≥n**: An√°lisis de patrones de errores

#### ‚ö†Ô∏è **WARNING - Respuesta Lenta**
- **Trigger**: Tiempo >5 segundos (configurable)
- **Threshold**: Basado en `alert_threshold_response_time`
- **Acci√≥n**: Monitoreo de performance

#### üóÑÔ∏è **ERROR - Error de Base de Datos**
- **Trigger**: Endpoints de DB fallan
- **Threshold**: 2+ endpoints con error
- **Acci√≥n**: Verificaci√≥n de conectividad

#### üî• **WARNING - CPU Alto**
- **Trigger**: CPU >85%
- **Threshold**: Sostenido por 2+ mediciones
- **Acci√≥n**: Monitoreo de recursos

#### üíæ **WARNING - Memoria Alta**
- **Trigger**: Memoria >90%
- **Threshold**: Sostenido por 2+ mediciones
- **Acci√≥n**: Monitoreo de memoria

### Configuraci√≥n de Alertas

#### Thresholds por Defecto
```python
thresholds = {
    "error_rate_per_hour": 5,
    "response_time_seconds": 5.0,
    "cpu_percent": 85.0,
    "memory_percent": 90.0,
    "consecutive_failures": 3
}
```

#### Cooldown de Notificaciones
- **Tiempo**: 15 minutos entre notificaciones del mismo tipo
- **Prop√≥sito**: Evitar spam de alertas
- **Excepci√≥n**: Alertas CRITICAL siempre se env√≠an

#### Resoluci√≥n Autom√°tica
- Las alertas se resuelven autom√°ticamente cuando la condici√≥n mejora
- Se env√≠a notificaci√≥n de resoluci√≥n para alertas CRITICAL y ERROR
- Se registra el tiempo de duraci√≥n del problema

---

## üí° Ejemplos de Uso

### Ejemplo 1: Monitoreo B√°sico (1 hora)

```bash
# Terminal 1: Iniciar monitoreo
python scripts/start_railway_monitoring.py --duration 1

# Terminal 2: Ver logs en tiempo real
tail -f logs/railway_monitor.log

# Browser: Ver dashboard
open https://tu-app.up.railway.app/railway-monitor
```

**Resultado esperado:**
- ‚úÖ Monitoreo activo por 1 hora
- ‚úÖ Logs guardados en `logs/railway_monitor_YYYYMMDD.json`
- ‚úÖ Reporte final en `logs/railway_monitor_report_YYYYMMDD_HHMMSS.json`

### Ejemplo 2: Monitoreo de Alta Frecuencia

```bash
# Verificaciones cada 10 segundos con alertas estrictas
python scripts/start_railway_monitoring.py \
  --interval 10 \
  --error-threshold 3 \
  --response-threshold 2.0
```

**Uso recomendado:**
- üéØ Durante deployments cr√≠ticos
- üéØ Despu√©s de cambios importantes
- üéØ Per√≠odos de alto tr√°fico

### Ejemplo 3: Solo Monitoreo (Sin Alertas)

```bash
# Monitoreo silencioso para recolecci√≥n de datos
python scripts/start_railway_monitoring.py \
  --no-alerts \
  --duration 24
```

**Uso recomendado:**
- üìä An√°lisis de performance
- üìä Recolecci√≥n de m√©tricas base
- üìä Testing de nuevas features

### Ejemplo 4: Verificaci√≥n R√°pida del Sistema

```bash
# Solo verificar que todo est√© funcionando
python scripts/start_railway_monitoring.py --check-only
```

**Output esperado:**
```
üîç Verificando dependencias...
   ‚úÖ aiohttp
   ‚úÖ psutil
   ‚úÖ fastapi
‚úÖ Todas las dependencias est√°n instaladas

üîß Verificando configuraci√≥n...
   ‚úÖ ENVIRONMENT: production
   ‚úÖ WHATSAPP_ENABLED: True
   ‚úÖ SMTP_HOST: smtp.gmail.com
‚úÖ Configuraci√≥n verificada

üåê Probando conectividad...
   ‚úÖ Railway responde: HTTP 200
‚úÖ Verificaci√≥n del sistema completada
```

### Ejemplo 5: Usar la API desde Python

```python
import asyncio
import aiohttp

async def get_system_metrics():
    """Obtener m√©tricas del sistema"""
    async with aiohttp.ClientSession() as session:
        url = "https://tu-app.up.railway.app/api/v1/railway/metrics"
        async with session.get(url) as response:
            if response.status == 200:
                data = await response.json()
                print(f"CPU: {data['cpu_usage']}%")
                print(f"Memoria: {data['memory_usage']}%")
                print(f"Respuesta: {data['response_time']}ms")
                print(f"Errores: {data['error_rate']}/hora")
            else:
                print(f"Error: {response.status}")

# Ejecutar
asyncio.run(get_system_metrics())
```

### Ejemplo 6: Crear Alerta Personalizada

```python
import asyncio
import aiohttp

async def create_custom_alert():
    """Crear alerta personalizada"""
    alert_data = {
        "level": "warning",
        "title": "üîß Mantenimiento Programado",
        "message": "El sistema entrar√° en mantenimiento en 30 minutos",
        "details": {
            "maintenance_start": "2024-01-15T14:00:00Z",
            "duration": "30 minutes",
            "affected_services": ["database", "api"]
        }
    }
    
    async with aiohttp.ClientSession() as session:
        url = "https://tu-app.up.railway.app/api/v1/railway/alerts"
        async with session.post(url, json=alert_data) as response:
            if response.status == 200:
                result = await response.json()
                print(f"‚úÖ Alerta creada: {result['message']}")
            else:
                print(f"‚ùå Error: {response.status}")

# Ejecutar
asyncio.run(create_custom_alert())
```

---

## üîß Soluci√≥n de Problemas

### Problemas Comunes

#### 1. **Error: ModuleNotFoundError**

```bash
‚ùå Error importando m√≥dulos: No module named 'aiohttp'
```

**Soluci√≥n:**
```bash
pip install -r requirements.txt
# o espec√≠ficamente:
pip install aiohttp psutil fastapi pydantic
```

#### 2. **Error de conectividad a Railway**

```bash
‚ùå Error de conectividad: Cannot connect to host
```

**Posibles causas:**
- Railway app no est√° desplegada
- URL incorrecta en configuraci√≥n
- Firewall bloqueando conexiones

**Soluci√≥n:**
```bash
# Verificar que la app est√© funcionando
curl https://tu-app.up.railway.app/debug

# Verificar variables de entorno
python -c "from core.config import settings; print(settings.ENVIRONMENT)"
```

#### 3. **Notificaciones no se env√≠an**

```bash
‚ùå Error enviando email: Authentication failed
```

**Soluci√≥n para email:**
```bash
# Verificar configuraci√≥n SMTP
python -c "
from core.config import settings
print(f'SMTP_HOST: {settings.SMTP_HOST}')
print(f'SMTP_USER: {settings.SMTP_USER}')
print(f'SMTP_PASSWORD: {len(settings.SMTP_PASSWORD)} caracteres')
"

# Probar notificaciones
python scripts/start_railway_monitoring.py --test-notifications
```

**Soluci√≥n para WhatsApp:**
- Verificar que Evolution API est√© funcionando
- Verificar `WHATSAPP_ENABLED=True`
- Verificar `WHATSAPP_NOTIFICATIONS_ENABLED=True`

#### 4. **Dashboard no carga**

```bash
‚ùå 404 Not Found: /railway-monitor
```

**Soluci√≥n:**
```bash
# Verificar que el archivo existe
ls -la static/railway_dashboard.html

# Verificar que la ruta est√© registrada en main.py
grep -n "railway-monitor" main.py

# Reiniciar la aplicaci√≥n
# (en Railway se hace autom√°ticamente al hacer deploy)
```

#### 5. **Logs no se guardan**

```bash
‚ùå Error procesando logs: Permission denied
```

**Soluci√≥n:**
```bash
# Crear directorio de logs
mkdir -p logs

# Verificar permisos
ls -la logs/

# En Railway, los logs se guardan en memoria, usar la API para exportar
curl https://tu-app.up.railway.app/api/v1/railway/export/logs
```

### Debugging Avanzado

#### Verificar Estado del Monitor

```python
# En una consola Python
from core.railway_log_monitor import RailwayLogMonitor
monitor = RailwayLogMonitor()
print(f"Monitoring active: {monitor.monitoring_active}")
print(f"Log buffer size: {len(monitor.log_buffer)}")
```

#### Verificar Estado de Alertas

```python
from core.railway_alerts import alerts_manager
print(f"Active alerts: {len(alerts_manager.get_active_alerts())}")
print(f"Alert history: {len(alerts_manager.get_alert_history(24))}")
```

#### Ver Logs Detallados

```bash
# Logs del sistema
tail -f logs/railway_monitor.log

# Logs de la aplicaci√≥n principal
tail -f logs/app.log

# En Railway, usar Railway CLI
railway logs
```

---

## üîÑ Mantenimiento

### Tareas de Mantenimiento Regular

#### Diario
- ‚úÖ Verificar que el dashboard est√° accesible
- ‚úÖ Revisar alertas activas
- ‚úÖ Verificar √∫ltimas m√©tricas

#### Semanal  
- ‚úÖ Exportar y revisar logs de la semana
- ‚úÖ Verificar uso de recursos (CPU/memoria tendencias)
- ‚úÖ Probar sistema de notificaciones
- ‚úÖ Limpiar logs antiguos (si aplicable)

#### Mensual
- ‚úÖ Revisar y ajustar thresholds de alertas
- ‚úÖ Analizar patrones de errores hist√≥ricos
- ‚úÖ Optimizar configuraci√≥n basada en datos recolectados
- ‚úÖ Actualizar documentaci√≥n si hay cambios

### Scripts de Mantenimiento

#### Verificaci√≥n de Salud Semanal
```bash
#!/bin/bash
# weekly_health_check.sh

echo "üè• Verificaci√≥n de salud semanal - $(date)"

# Verificar sistema
python scripts/start_railway_monitoring.py --check-only

# Probar notificaciones
python scripts/start_railway_monitoring.py --test-notifications

# Exportar m√©tricas de la semana
curl "https://tu-app.up.railway.app/api/v1/railway/metrics/history?hours=168" \
  -o "reports/weekly_metrics_$(date +%Y%m%d).json"

echo "‚úÖ Verificaci√≥n completada"
```

#### Limpieza de Logs
```bash
#!/bin/bash
# cleanup_logs.sh

echo "üßπ Limpiando logs antiguos..."

# Mantener solo logs de los √∫ltimos 30 d√≠as
find logs/ -name "*.json" -mtime +30 -delete
find logs/ -name "*.log" -mtime +30 -delete

echo "‚úÖ Limpieza completada"
```

### Actualizaciones del Sistema

#### Actualizar Dependencias
```bash
# Actualizar requirements.txt
pip list --outdated
pip install --upgrade aiohttp psutil fastapi pydantic

# Generar nuevo requirements.txt
pip freeze > requirements.txt
```

#### Backup de Configuraci√≥n
```bash
# Backup de configuraci√≥n actual
cp railway.env.example railway.env.backup.$(date +%Y%m%d)
cp core/config.py core/config.py.backup.$(date +%Y%m%d)
```

### Monitoreo del Monitoreo

Para asegurar que el sistema de monitoreo est√© siempre funcionando:

#### Cron Job (si tienes acceso a cron)
```cron
# Verificar cada hora que el monitoreo est√© activo
0 * * * * curl -f https://tu-app.up.railway.app/api/v1/railway/health || echo "Monitor down!" | mail admin@tu-dominio.com
```

#### Health Check Externo
Usar servicios como UptimeRobot o Pingdom para monitorear:
- `https://tu-app.up.railway.app/api/v1/railway/health`
- `https://tu-app.up.railway.app/railway-monitor`

---

## üìû Soporte y Contacto

### Recursos de Ayuda

1. **Documentaci√≥n t√©cnica**: Este archivo
2. **Logs del sistema**: `logs/railway_monitor.log`
3. **Dashboard de estado**: `/railway-monitor`
4. **API de diagn√≥stico**: `/api/v1/railway/health`

### Informaci√≥n para Soporte

Cuando contactes soporte, incluye:

```bash
# Informaci√≥n del sistema
python --version
pip list | grep -E "(aiohttp|psutil|fastapi|pydantic)"

# Estado de la configuraci√≥n
python -c "
from core.config import settings
print(f'Environment: {settings.ENVIRONMENT}')
print(f'Version: {settings.VERSION}')
print(f'Railway URL: Railway app URL')
"

# √öltimos logs (√∫ltimas 20 l√≠neas)
tail -20 logs/railway_monitor.log

# Estado actual del sistema
curl https://tu-app.up.railway.app/api/v1/railway/status
```

---

## üéâ ¬°Felicitaciones!

Has configurado exitosamente el **Sistema de Monitoreo de Railway** para tu aplicaci√≥n ClickUp Project Manager. 

### ¬øQu√© sigue?

1. **Personaliza los thresholds** seg√∫n tus necesidades
2. **Configura las notificaciones** para tu equipo
3. **Monitorea regularmente** el dashboard
4. **Ajusta la configuraci√≥n** bas√°ndose en los datos recolectados

### Recursos Adicionales

- üìö [Documentaci√≥n de Railway](https://docs.railway.app/)
- üìö [FastAPI Documentation](https://fastapi.tiangolo.com/)
- üìö [Chart.js Documentation](https://www.chartjs.org/)

---

**¬°Tu sistema ahora est√° completamente monitoreado! üöÄ**

*√öltima actualizaci√≥n: Enero 2024*
